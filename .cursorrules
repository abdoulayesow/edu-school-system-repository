# GSPN School Management System - Cursor Rules

## Project Overview

**Project Name:** GSPN (Groupe Scolaire Privé Ndiolou) School Management System  
**Goal:** Increase school operational efficiency by 40% within 6 months  
**Target Market:** African schools with offline-first capabilities, low-cost hosting

This is a comprehensive school management system with multi-tenant support, role-based access control, and offline-first architecture.

---

## Technology Stack

### Frontend
- **Framework:** Next.js 16 (App Router)
- **UI Library:** React 19
- **Language:** TypeScript (strict mode)
- **Styling:** Tailwind CSS 4.x + shadcn/ui components (New York style)
- **State Management:** Zustand + TanStack Query (React Query)
- **Forms:** React Hook Form + Zod validation
- **Icons:** Lucide React
- **PWA:** Serwist (currently disabled in dev)
- **PDF Generation:** @react-pdf/renderer
- **Date Handling:** date-fns

### Backend
- **Runtime:** Next.js API Routes (Edge/Node.js)
- **Database:** PostgreSQL (Neon) with Prisma ORM v7
- **Authentication:** NextAuth.js v4
- **API Pattern:** RESTful API routes in `app/ui/app/api`
- **Validation:** Zod schemas

### Development Tools
- **Package Manager:** npm (monorepo with workspaces)
- **Linting:** ESLint with Next.js + TypeScript rules
- **Formatting:** Prettier with Tailwind plugin
- **Testing:** Vitest (unit) + Playwright (E2E)
- **Type Checking:** TypeScript strict mode

### Infrastructure
- **Hosting:** Vercel
- **Database:** Neon PostgreSQL (pooled connection)
- **File Storage:** (To be determined)
- **CI/CD:** GitHub Actions

---

## Project Structure

```
edu-school-system-repository/
├── app/
│   ├── ui/              # Next.js frontend application
│   │   ├── app/         # Next.js App Router pages & API routes
│   │   ├── components/  # React components organized by feature
│   │   ├── lib/         # Utilities, helpers, and shared code
│   │   ├── hooks/       # Custom React hooks
│   │   ├── styles/      # Global styles
│   │   └── public/      # Static assets
│   ├── db/              # Database layer
│   │   └── prisma/      # Prisma schema, migrations, seed
│   └── api/             # Shared API utilities (minimal)
├── docs/                # Documentation
│   ├── architecture/    # System architecture docs
│   ├── summaries/       # Session summaries (daily work logs)
│   ├── testing/         # Test plans and guides
│   └── [feature]/       # Feature-specific docs
├── tests/               # E2E tests (Playwright)
└── scripts/             # Utility scripts
```

---

## Coding Standards

### TypeScript

- **Strict Mode:** Always enabled
- **No `any` types:** Use `unknown` or proper types. Error level enforcement.
- **Explicit Return Types:** Recommended (warning level) for functions, required for exported functions
- **Unused Variables:** Prefix with `_` to ignore (e.g., `_unusedParam`)
- **Type Definitions:** Define interfaces/types close to usage, or in shared `types/` directory

### Naming Conventions

- **Files:** kebab-case for files (e.g., `step-grade-selection.tsx`)
- **Components:** PascalCase (e.g., `StepGradeSelection`)
- **Functions/Variables:** camelCase (e.g., `handleSelectGrade`, `isLoading`)
- **Constants:** UPPER_SNAKE_CASE (e.g., `MAX_RETRY_ATTEMPTS`)
- **Types/Interfaces:** PascalCase (e.g., `GradeSelectionFormData`)
- **API Routes:** kebab-case in `app/api/[route]/route.ts`
- **Database Models:** PascalCase singular (e.g., `User`, `Enrollment`)

### Code Style

- **Quotes:** Single quotes for strings (`'hello'`)
- **Semicolons:** Required
- **Trailing Commas:** ES5 style (objects, arrays)
- **Indentation:** 2 spaces (no tabs)
- **Line Width:** 100 characters (Prettier enforced)
- **Arrow Parens:** Always include (`(x) => x`, not `x => x`)
- **JSX Quotes:** Double quotes (`<div className="foo">`)

### Import Organization

1. External dependencies (React, Next.js, etc.)
2. Internal absolute imports (`@/components`, `@/lib`)
3. Relative imports (`./component`, `../utils`)
4. Type imports last (if separate)

Example:
```typescript
import { useEffect, useState } from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { useEnrollmentWizard } from '../wizard-context'
import { useI18n } from '@/components/i18n-provider'
import type { SchoolLevel } from '@/lib/enrollment/types'
```

### Component Patterns

- **Client Components:** Use `"use client"` directive at top of file
- **Server Components:** Default (no directive needed)
- **Component Structure:**
  1. Imports
  2. Types/Interfaces
  3. Component definition
  4. Export default

```typescript
"use client"

import { useState } from 'react'
import { Card } from '@/components/ui/card'

interface Props {
  title: string
  children: React.ReactNode
}

export function MyComponent({ title, children }: Props) {
  const [isOpen, setIsOpen] = useState(false)
  // Component logic
  return <Card>{children}</Card>
}
```

### Error Handling

- **API Routes:** Always use try/catch, return proper HTTP status codes
- **Error Responses:** Consistent format: `{ error: string }` or `{ message: string, errors?: [] }`
- **Validation Errors:** Use Zod with detailed error messages
- **Console Logging:** Only use `console.warn` or `console.error` (no `console.log`)

```typescript
export async function POST(req: NextRequest) {
  try {
    const body = await req.json()
    const validated = schema.parse(body)
    // ... processing
    return NextResponse.json(result, { status: 201 })
  } catch (err) {
    if (err instanceof z.ZodError) {
      return NextResponse.json(
        { message: 'Validation error', errors: err.errors },
        { status: 400 }
      )
    }
    console.error('Error:', err)
    return NextResponse.json(
      { message: 'Internal server error' },
      { status: 500 }
    )
  }
}
```

### Database Patterns

- **Prisma Client:** Import from `@/lib/prisma` (shared instance)
- **Queries:** Use Prisma query builder with proper types
- **Transactions:** Use `prisma.$transaction()` for multi-step operations
- **Error Handling:** Handle Prisma errors gracefully (unique constraints, etc.)
- **Relations:** Always include related data when needed via `include` or `select`

### Authentication & Authorization

- **Session Check:** Use `requireSession()` from `@/lib/authz` for API routes
- **Role Check:** Use `requireRole(['director', 'accountant'])` for role-based access
- **User Context:** Use NextAuth `getServerSession()` in API routes
- **Protected Routes:** Use middleware or server-side checks

### Internationalization (i18n)

- **Translation Keys:** Use `useI18n()` hook from `@/components/i18n-provider`
- **Language Files:** Located in `app/ui/lib/i18n/` (en.ts, fr.ts)
- **Key Naming:** Use dot notation (e.g., `enrollment.studentInformation`)
- **Always provide translations:** Both English and French

```typescript
const { t } = useI18n()
// Usage: t('enrollment.studentInformation')
```

### Testing Standards

- **Unit Tests:** Vitest, located next to files (`*.test.ts`) or in `__tests__/`
- **E2E Tests:** Playwright, located in `tests/e2e/`
- **Test Coverage:** Aim for 70%+ (lines, functions, branches)
- **Test Data:** Use factories or seed scripts, never hardcode IDs

---

## Architectural Patterns

### API Routes

- **Location:** `app/ui/app/api/[route]/route.ts`
- **HTTP Methods:** Export named functions (`GET`, `POST`, `PATCH`, `DELETE`)
- **Request/Response:** Use Next.js `NextRequest` and `NextResponse`
- **Validation:** Always validate input with Zod schemas
- **Error Responses:** Consistent error format with appropriate status codes

### Component Architecture

- **Feature-Based Organization:** Components grouped by feature (enrollment, students, etc.)
- **UI Components:** shadcn/ui components in `components/ui/`
- **Feature Components:** Domain-specific components in `components/[feature]/`
- **Shared Components:** Common components in `components/` root
- **Hooks:** Custom hooks in `hooks/` directory
- **Context:** Use React Context for complex shared state (e.g., `wizard-context.tsx`)

### State Management

- **Server State:** TanStack Query for server data (caching, refetching)
- **Client State:** 
  - React `useState` for local component state
  - Zustand for global UI state (modals, sidebar, etc.)
  - Context API for feature-specific shared state
- **Form State:** React Hook Form with Zod validation

### File Organization

- **Pages:** `app/[route]/page.tsx` (Next.js App Router)
- **Layouts:** `app/[route]/layout.tsx`
- **API Routes:** `app/api/[route]/route.ts`
- **Components:** `components/[feature]/[component].tsx`
- **Utilities:** `lib/[category]/[utility].ts`
- **Types:** Co-located with components or in `lib/[feature]/types.ts`

---

## Database Conventions

### Prisma Schema

- **Model Naming:** PascalCase singular (`User`, `Enrollment`)
- **Field Naming:** camelCase (`firstName`, `createdAt`)
- **Relations:** Use proper `@relation` attributes
- **Timestamps:** Always include `createdAt` and `updatedAt`
- **Enums:** PascalCase (`UserStatus`, `Role`)
- **IDs:** Use `@default(cuid())` for String IDs or `@id @default(autoincrement())` for integers

### Migrations

- **Naming:** Descriptive migration names
- **Review:** Always review generated migrations before applying
- **Rollback:** Consider rollback strategy before applying

### Seed Data

- **Location:** `app/db/prisma/seed.ts`
- **Idempotent:** Seed scripts should be safe to run multiple times
- **Test Data:** Create realistic test data for development

---

## Git & Workflow

### Branch Naming

- **Feature:** `feature/[feature-name]`
- **Fix:** `fix/[issue-description]`
- **Refactor:** `refactor/[description]`
- **Docs:** `docs/[description]`

### Commit Messages

- **Format:** Follow conventional commits
- **Examples:**
  - `feat: add grade capacity indicator`
  - `fix: resolve navigation button click issue`
  - `refactor: extract enrollment validation logic`
  - `docs: update architecture documentation`

### PR Process

- **Description:** Include context, changes, and testing notes
- **Testing:** Ensure tests pass and manual testing completed
- **Review:** Request review before merging

---

## Important Notes

### Architecture vs Implementation

⚠️ **IMPORTANT:** The `docs/architecture/architecture.md` describes a **target architecture** using Drizzle/Turso/tRPC/offline-first. However, the **current implementation** uses:
- **Prisma** (not Drizzle) 
- **PostgreSQL/Neon** (not Turso)
- **Next.js API Routes** (not tRPC)
- **NextAuth.js** (as planned)
- **Offline-first** (planned but not fully implemented)

When making decisions, prioritize the **current implementation patterns** over the architecture doc unless explicitly migrating.

### Key Decisions

1. **Database:** PostgreSQL with Prisma (decided, not changing)
2. **API:** RESTful Next.js API routes (decided, not changing)
3. **Offline Support:** Planned but using PWA patterns when ready
4. **Multi-tenant:** Single school for now, multi-tenant architecture prepared

### Current Branch & Status

- **Active Branch:** `fix/manifest-and-icons` (PR #8)
- **Recent Work:** Enrollment improvements completed (2025-12-29)
- **Status:** Development in progress, features being added iteratively

---

## Common Tasks

### Adding a New Feature

1. Create component in `components/[feature]/`
2. Create API route in `app/api/[feature]/route.ts` if needed
3. Update Prisma schema if database changes needed
4. Add translations in `lib/i18n/en.ts` and `lib/i18n/fr.ts`
5. Add types in `lib/[feature]/types.ts` if complex
6. Write tests (unit + E2E if critical path)
7. Update documentation if needed

### Adding a New API Endpoint

1. Create route file: `app/api/[route]/route.ts`
2. Add authentication/authorization checks
3. Validate input with Zod schema
4. Handle errors properly
5. Return consistent response format
6. Document in code comments if complex

### Adding Database Changes

1. Update `app/db/prisma/schema.prisma`
2. Generate migration: `npx prisma migrate dev --name [description]`
3. Update seed data if needed
4. Test migration locally
5. Update TypeScript types (Prisma generates automatically)

---

## Best Practices

### Performance

- **Server Components:** Prefer Server Components when possible
- **Code Splitting:** Use dynamic imports for large components
- **Image Optimization:** Use Next.js `Image` component
- **Database Queries:** Use `select` to fetch only needed fields
- **Caching:** Use TanStack Query caching for server state

### Security

- **Input Validation:** Always validate with Zod
- **Authentication:** Check session on protected routes
- **Authorization:** Verify user roles before sensitive operations
- **SQL Injection:** Prisma handles this, but never use raw queries with user input
- **XSS:** React escapes by default, but sanitize rich text input

### Accessibility

- **Semantic HTML:** Use proper HTML elements
- **ARIA Labels:** Add when needed for screen readers
- **Keyboard Navigation:** Ensure all interactions are keyboard accessible
- **Color Contrast:** Follow WCAG guidelines (shadcn/ui handles this)

### Error Handling

- **User-Friendly Messages:** Never expose internal errors to users
- **Error Logging:** Log errors server-side for debugging
- **Graceful Degradation:** Handle offline/error states gracefully
- **Validation Errors:** Show specific field-level errors

---

## Tools & Scripts

### Development

```bash
npm run dev              # Start dev server (port 8000)
npm run build           # Build for production
npm run lint            # Run ESLint
npm run lint:fix        # Fix ESLint errors
npm run format          # Format with Prettier
npm run typecheck       # Type check with TypeScript
```

### Database

```bash
npm run db:seed         # Seed database
npm run db:validate     # Validate Prisma schema
npm run db:format       # Format Prisma schema
```

### Testing

```bash
npm test                # Run unit tests
npm run test:e2e        # Run E2E tests
npm run test:e2e:ui     # Run E2E tests with UI
```

---

## Resources

- **Architecture Docs:** `docs/architecture/architecture.md`
- **Database Schema:** `docs/database/database-schema.md`
- **Session Summaries:** `docs/summaries/` (daily work logs)
- **Testing Guides:** `docs/testing/`
- **Product Docs:** `docs/product/`

---

## Questions or Issues?

- Check session summaries in `docs/summaries/` for recent work context
- Review architecture docs for system design decisions
- Check GitHub PRs/issues for ongoing discussions

---

**Last Updated:** 2025-12-29  
**Version:** 1.0
