generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  relationMode = "prisma"
}

model User {
  id            String     @id @default(cuid())
  name          String?
  email         String?    @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  dateOfBirth   DateTime?
  phone         String?
  role          Role       @default(user)
  status        UserStatus @default(active)

  // === STAFF ROLE & PERMISSIONS ===
  staffRole          StaffRole? // Staff role for RBAC (null for legacy users)
  staffProfileId     String?      @unique // Link to TeacherProfile for scope checking
  schoolLevel        SchoolLevel? // Primary school level (for scope filtering)
  mustChangePassword Boolean      @default(false) // Force password change on first login

  accounts                   Account[]
  sessions                   Session[]
  address                    Address?
  passwordResetTokens        PasswordResetToken[]
  createdEnrollments         Enrollment[]            @relation("EnrollmentCreator")
  approvedEnrollments        Enrollment[]            @relation("EnrollmentApprover")
  statusChangedEnrollments   Enrollment[]            @relation("EnrollmentStatusChanger")
  recordedPayments           Payment[]               @relation("PaymentRecorder")
  confirmedPayments          Payment[]               @relation("PaymentConfirmer")
  reviewedPayments           Payment[]               @relation("PaymentReviewer")
  enrollmentNotes            EnrollmentNote[]
  attendanceSessions         AttendanceSession[]     @relation("AttendanceSessionRecorder")
  attendanceRecords          AttendanceRecord[]      @relation("AttendanceRecordRecorder")
  depositedCash              CashDeposit[]           @relation("CashDepositor")
  verifiedDeposits           CashDeposit[]           @relation("DepositVerifier")
  recordedBankDeposits       BankDeposit[]           @relation("BankDepositRecorder")
  reconciledBankDeposits     BankDeposit[]           @relation("BankDepositReconciler")
  requestedExpenses          Expense[]               @relation("ExpenseRequester")
  approvedExpenses           Expense[]               @relation("ExpenseApprover")
  initiatedExpenses          Expense[]               @relation("ExpenseInitiator")
  assignedRoomAssignments    StudentRoomAssignment[] @relation("RoomAssigner")
  sentInvitations            UserInvitation[]        @relation("InvitationSender")
  createdClubs               Club[]                  @relation("ClubCreator")
  clubEnrollments            ClubEnrollment[]        @relation("ClubEnroller")
  recordedClubPayments       ClubPayment[]           @relation("ClubPaymentRecorder")
  confirmedClubPayments      ClubPayment[]           @relation("ClubPaymentConfirmer")
  recordedEvaluations        Evaluation[]            @relation("EvaluationRecorder")
  trimesterDecisionOverrides StudentTrimester[]      @relation("TrimesterDecisionOverrider")
  // Treasury relations
  treasuryVerifications      TreasuryBalance[]       @relation("SafeVerifier")
  safeTransactions           SafeTransaction[]       @relation("SafeTransactionRecorder")
  bankTransfers              BankTransfer[]          @relation("BankTransferRecorder")
  dailyVerifications         DailyVerification[]     @relation("DailyVerifier")
  discrepancyReviews         DailyVerification[]     @relation("DiscrepancyReviewer")
  reconciliationsPerformed   ReconciliationEvent[]   @relation("ReconciliationPerformer")
  reconciliationsReviewed    ReconciliationEvent[]   @relation("ReconciliationReviewer")
  // Permission & audit relations
  permissionOverrides        PermissionOverride[]    @relation("UserPermissionOverrides")
  grantedOverrides           PermissionOverride[]    @relation("GrantedPermissionOverrides")
  auditLogs                  AuditLog[]

  // Link to staff profile for teachers
  staffProfile TeacherProfile? @relation("UserStaffProfile", fields: [staffProfileId], references: [id])

  @@index([staffRole])
  @@index([schoolLevel])
  @@index([staffProfileId])
}

model Address {
  id      String  @id @default(cuid())
  street  String?
  city    String?
  state   String?
  zip     String?
  country String?
  userId  String  @unique
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model SchoolYear {
  id                     String                  @id @default(cuid())
  name                   String
  startDate              DateTime
  endDate                DateTime
  enrollmentStart        DateTime
  enrollmentEnd          DateTime
  isActive               Boolean                 @default(false)
  syncVersion            Int                     @default(0)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  status                 SchoolYearStatus        @default(new)
  grades                 Grade[]
  enrollments            Enrollment[]
  classAssignments       ClassAssignment[]
  gradeEnrollments       GradeEnrollment[]
  studentRoomAssignments StudentRoomAssignment[]
  clubs                  Club[]
  timePeriods            TimePeriod[]
  trimesters             Trimester[]

  @@index([isActive])
  @@index([startDate])
  @@index([status])
}

model Grade {
  id                 String                @id @default(cuid())
  name               String
  code               String?
  level              SchoolLevel
  order              Int
  tuitionFee         Int
  schoolYearId       String
  gradeLeaderId      String?
  syncVersion        Int                   @default(0)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  capacity           Int                   @default(70)
  isEnabled          Boolean               @default(true)
  series             String?
  schoolYear         SchoolYear            @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  gradeLeader        TeacherProfile?       @relation("GradeLeader", fields: [gradeLeaderId], references: [id])
  enrollments        Enrollment[]
  subjects           GradeSubject[]
  currentStudents    StudentProfile[]      @relation("CurrentGradeStudents")
  gradeEnrollments   GradeEnrollment[]
  attendanceSessions AttendanceSession[]
  rooms              GradeRoom[]
  trimesterStats     ClassTrimesterStats[]
  clubGradeRules     ClubGradeRule[]

  @@unique([schoolYearId, order, series])
  @@index([schoolYearId])
  @@index([level])
  @@index([order])
  @@index([gradeLeaderId])
  @@index([isEnabled])
}

model Enrollment {
  id                      String            @id @default(cuid())
  enrollmentNumber        String?           @unique
  studentId               String?
  schoolYearId            String
  gradeId                 String
  firstName               String
  lastName                String
  dateOfBirth             DateTime?
  gender                  String?
  phone                   String?
  email                   String?
  photoUrl                String?
  birthCertificateUrl     String?
  fatherName              String?
  fatherPhone             String?
  fatherEmail             String?
  motherName              String?
  motherPhone             String?
  motherEmail             String?
  address                 String?
  originalTuitionFee      Int
  adjustedTuitionFee      Int?
  adjustmentReason        String?
  status                  EnrollmentStatus  @default(draft)
  currentStep             Int               @default(1)
  isReturningStudent      Boolean           @default(false)
  draftExpiresAt          DateTime?
  submittedAt             DateTime?
  approvedAt              DateTime?
  approvedBy              String?
  autoApproveAt           DateTime?
  statusComment           String?
  statusChangedAt         DateTime?
  statusChangedBy         String?
  createdBy               String
  syncVersion             Int               @default(0)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  middleName              String?
  enrollingPersonEmail    String?
  enrollingPersonName     String?
  enrollingPersonPhone    String?
  enrollingPersonRelation String?
  enrollingPersonType     String?
  schoolYear              SchoolYear        @relation(fields: [schoolYearId], references: [id])
  grade                   Grade             @relation(fields: [gradeId], references: [id])
  student                 Student?          @relation(fields: [studentId], references: [id])
  creator                 User              @relation("EnrollmentCreator", fields: [createdBy], references: [id])
  approver                User?             @relation("EnrollmentApprover", fields: [approvedBy], references: [id])
  statusChanger           User?             @relation("EnrollmentStatusChanger", fields: [statusChangedBy], references: [id])
  paymentSchedules        PaymentSchedule[]
  payments                Payment[]
  notes                   EnrollmentNote[]

  @@index([status, schoolYearId])
  @@index([schoolYearId])
  @@index([gradeId])
  @@index([studentId])
  @@index([createdBy])
  @@index([draftExpiresAt])
  @@index([updatedAt])
  @@index([statusChangedBy])
  @@index([status, approvedAt])
}

model PaymentSchedule {
  id             String     @id @default(cuid())
  enrollmentId   String
  scheduleNumber Int
  amount         Int
  months         String[]
  dueDate        DateTime
  isPaid         Boolean    @default(false)
  paidAt         DateTime?
  syncVersion    Int        @default(0)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  enrollment     Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  payments       Payment[]

  @@unique([enrollmentId, scheduleNumber])
  @@index([enrollmentId])
  @@index([dueDate])
}

model Payment {
  id                String           @id @default(cuid())
  enrollmentId      String?
  clubEnrollmentId  String?
  paymentType       PaymentType      @default(tuition)
  paymentScheduleId String?
  amount            Int
  method            PaymentMethod
  status            PaymentStatus    @default(confirmed)
  receiptNumber     String           @unique
  transactionRef    String?
  receiptImageUrl   String?
  recordedBy        String
  recordedAt        DateTime         @default(now())
  confirmedBy       String?
  confirmedAt       DateTime?
  notes             String?
  reviewedBy        String?
  reviewedAt        DateTime?
  reviewNotes       String?
  autoConfirmAt     DateTime?
  syncVersion       Int              @default(0)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  enrollment        Enrollment?      @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  clubEnrollment    ClubEnrollment?  @relation(fields: [clubEnrollmentId], references: [id], onDelete: Cascade)
  paymentSchedule   PaymentSchedule? @relation(fields: [paymentScheduleId], references: [id])
  recorder          User             @relation("PaymentRecorder", fields: [recordedBy], references: [id])
  confirmer         User?            @relation("PaymentConfirmer", fields: [confirmedBy], references: [id])
  reviewer          User?            @relation("PaymentReviewer", fields: [reviewedBy], references: [id])
  cashDeposit       CashDeposit?

  @@index([enrollmentId])
  @@index([clubEnrollmentId])
  @@index([paymentType])
  @@index([paymentScheduleId])
  @@index([status])
  @@index([recordedBy])
  @@index([recordedAt])
  @@index([reviewedBy])
  @@index([method])
  @@index([status, recordedAt])
}

model EnrollmentNote {
  id           String     @id @default(cuid())
  enrollmentId String
  title        String
  content      String
  createdBy    String
  syncVersion  Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  author       User       @relation(fields: [createdBy], references: [id])

  @@index([enrollmentId])
  @@index([createdBy])
}

model Student {
  id               String            @id @default(cuid())
  studentNumber    String?           @unique
  firstName        String
  lastName         String
  email            String?
  dateOfBirth      DateTime?
  guardianName     String?
  guardianPhone    String?
  guardianEmail    String?
  grade            String?
  status           StudentStatus     @default(active)
  enrollmentDate   DateTime          @default(now())
  syncVersion      Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  enrollments      Enrollment[]
  studentProfile   StudentProfile?
  safeTransactions SafeTransaction[]

  @@index([status])
  @@index([grade])
  @@index([updatedAt])
  @@index([studentNumber])
  @@index([firstName, lastName])
}

model Person {
  id             String          @id @default(cuid())
  firstName      String
  middleName     String?
  lastName       String
  email          String?         @unique
  phone          String?
  dateOfBirth    DateTime?
  gender         Gender?
  photoUrl       String?
  address        String?
  status         PersonStatus    @default(active)
  syncVersion    Int             @default(0)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  studentProfile StudentProfile?
  teacherProfile TeacherProfile?
  parentProfile  ParentProfile?

  @@index([email])
  @@index([firstName, lastName])
  @@index([status])
}

model StudentProfile {
  id                    String                    @id @default(cuid())
  personId              String                    @unique
  studentId             String?                   @unique
  studentNumber         String?                   @unique
  studentStatus         StudentStatus             @default(active)
  enrollmentDate        DateTime                  @default(now())
  currentGradeId        String?
  syncVersion           Int                       @default(0)
  createdAt             DateTime                  @default(now())
  updatedAt             DateTime                  @updatedAt
  isLockedForAutoAssign Boolean                   @default(false)
  person                Person                    @relation(fields: [personId], references: [id], onDelete: Cascade)
  student               Student?                  @relation(fields: [studentId], references: [id])
  currentGrade          Grade?                    @relation("CurrentGradeStudents", fields: [currentGradeId], references: [id])
  gradeEnrollments      GradeEnrollment[]
  attendanceRecords     AttendanceRecord[]
  parentLinks           StudentParent[]
  roomAssignments       StudentRoomAssignment[]
  clubEnrollments       ClubEnrollment[]
  evaluations           Evaluation[]
  subjectAverages       SubjectTrimesterAverage[]
  studentTrimesters     StudentTrimester[]

  @@index([personId])
  @@index([studentNumber])
  @@index([currentGradeId])
  @@index([studentStatus])
}

model TeacherProfile {
  id               String            @id @default(cuid())
  personId         String            @unique
  userId           String?           @unique
  employeeNumber   String?           @unique
  hireDate         DateTime?
  specialization   String?
  syncVersion      Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  person           Person            @relation(fields: [personId], references: [id], onDelete: Cascade)
  classAssignments ClassAssignment[]
  gradeLederships  Grade[]           @relation("GradeLeader")
  scheduleSlots    ScheduleSlot[]
  linkedUser       User?             @relation("UserStaffProfile") // Link to User for RBAC

  @@index([personId])
  @@index([employeeNumber])
}

model ParentProfile {
  id           String          @id @default(cuid())
  personId     String          @unique
  relationship String?
  syncVersion  Int             @default(0)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  person       Person          @relation(fields: [personId], references: [id], onDelete: Cascade)
  studentLinks StudentParent[]

  @@index([personId])
}

model StudentParent {
  id               String         @id @default(cuid())
  studentProfileId String
  parentProfileId  String
  isPrimary        Boolean        @default(false)
  createdAt        DateTime       @default(now())
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  parentProfile    ParentProfile  @relation(fields: [parentProfileId], references: [id], onDelete: Cascade)

  @@unique([studentProfileId, parentProfileId])
  @@index([studentProfileId])
  @@index([parentProfileId])
}

model Subject {
  id            String         @id @default(cuid())
  code          String         @unique
  nameFr        String
  nameEn        String
  isOptional    Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  gradeSubjects GradeSubject[]

  @@index([code])
}

model GradeSubject {
  id               String                    @id @default(cuid())
  gradeId          String
  subjectId        String
  coefficient      Int                       @default(1)
  hoursPerWeek     Int?
  series           String?
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  grade            Grade                     @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  subject          Subject                   @relation(fields: [subjectId], references: [id])
  classAssignments ClassAssignment[]
  scheduleSlots    ScheduleSlot[]
  evaluations      Evaluation[]
  subjectAverages  SubjectTrimesterAverage[]

  @@unique([gradeId, subjectId, series])
  @@index([gradeId])
  @@index([subjectId])
}

model ClassAssignment {
  id               String          @id @default(cuid())
  gradeSubjectId   String
  teacherProfileId String?
  schoolYearId     String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  gradeSubject     GradeSubject    @relation(fields: [gradeSubjectId], references: [id], onDelete: Cascade)
  teacherProfile   TeacherProfile? @relation(fields: [teacherProfileId], references: [id], onDelete: SetNull)
  schoolYear       SchoolYear      @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)

  @@unique([gradeSubjectId, schoolYearId])
  @@index([teacherProfileId])
  @@index([schoolYearId])
}

model TimePeriod {
  id            String         @id @default(cuid())
  name          String
  nameFr        String?
  startTime     String
  endTime       String
  order         Int
  schoolYearId  String
  isActive      Boolean        @default(true)
  syncVersion   Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  schoolYear    SchoolYear     @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  scheduleSlots ScheduleSlot[]

  @@unique([schoolYearId, order])
  @@index([schoolYearId])
  @@index([order])
  @@index([isActive])
}

model ScheduleSlot {
  id               String          @id @default(cuid())
  gradeRoomId      String
  timePeriodId     String
  dayOfWeek        DayOfWeek
  gradeSubjectId   String?
  teacherProfileId String?
  roomLocation     String?
  isBreak          Boolean         @default(false)
  notes            String?
  syncVersion      Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  gradeRoom        GradeRoom       @relation(fields: [gradeRoomId], references: [id], onDelete: Cascade)
  timePeriod       TimePeriod      @relation(fields: [timePeriodId], references: [id], onDelete: Cascade)
  gradeSubject     GradeSubject?   @relation(fields: [gradeSubjectId], references: [id], onDelete: SetNull)
  teacherProfile   TeacherProfile? @relation(fields: [teacherProfileId], references: [id], onDelete: SetNull)

  @@unique([gradeRoomId, timePeriodId, dayOfWeek])
  @@index([gradeRoomId])
  @@index([timePeriodId])
  @@index([dayOfWeek])
  @@index([teacherProfileId, dayOfWeek, timePeriodId])
  @@index([roomLocation, dayOfWeek, timePeriodId])
}

model GradeEnrollment {
  id               String         @id @default(cuid())
  studentProfileId String
  gradeId          String
  schoolYearId     String
  enrolledAt       DateTime       @default(now())
  status           String         @default("active")
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  grade            Grade          @relation(fields: [gradeId], references: [id])
  schoolYear       SchoolYear     @relation(fields: [schoolYearId], references: [id])

  @@unique([studentProfileId, gradeId, schoolYearId])
  @@index([studentProfileId])
  @@index([gradeId])
  @@index([schoolYearId])
}

model AttendanceSession {
  id          String              @id @default(cuid())
  gradeId     String
  date        DateTime            @db.Date
  entryMode   AttendanceEntryMode
  isComplete  Boolean             @default(false)
  completedAt DateTime?
  recordedBy  String
  syncVersion Int                 @default(0)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  grade       Grade               @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  recorder    User                @relation("AttendanceSessionRecorder", fields: [recordedBy], references: [id])
  records     AttendanceRecord[]

  @@unique([gradeId, date])
  @@index([gradeId])
  @@index([date])
  @@index([recordedBy])
  @@index([isComplete])
}

model AttendanceRecord {
  id               String            @id @default(cuid())
  sessionId        String
  studentProfileId String
  status           AttendanceStatus
  notes            String?
  recordedBy       String
  syncVersion      Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  session          AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentProfile   StudentProfile    @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  recorder         User              @relation("AttendanceRecordRecorder", fields: [recordedBy], references: [id])

  @@unique([sessionId, studentProfileId])
  @@index([studentProfileId])
  @@index([status])
  @@index([recordedBy])
}

model CashDeposit {
  id              String    @id @default(cuid())
  paymentId       String    @unique
  bankReference   String
  depositDate     DateTime
  depositedBy     String
  depositedByName String?
  bankName        String?
  verifiedBy      String?
  verifiedAt      DateTime?
  syncVersion     Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  payment         Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  depositor       User      @relation("CashDepositor", fields: [depositedBy], references: [id])
  verifier        User?     @relation("DepositVerifier", fields: [verifiedBy], references: [id])

  @@index([depositDate])
  @@index([bankReference])
  @@index([depositedBy])
  @@index([verifiedBy])
  @@index([verifiedBy, depositDate])
}

model BankDeposit {
  id                  String    @id @default(cuid())
  bankReference       String    @unique
  amount              Int
  depositDate         DateTime
  bankName            String
  depositorName       String
  recordedBy          String
  isReconciled        Boolean   @default(false)
  reconciledAt        DateTime?
  reconciledBy        String?
  reconciliationNotes String?
  syncVersion         Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  recorder            User      @relation("BankDepositRecorder", fields: [recordedBy], references: [id])
  reconciler          User?     @relation("BankDepositReconciler", fields: [reconciledBy], references: [id])

  @@index([depositDate])
  @@index([isReconciled])
  @@index([recordedBy])
  @@index([reconciledBy])
  @@index([depositDate, isReconciled])
}

model Supplier {
  id        String           @id @default(cuid())
  name      String
  category  ExpenseCategory? // null = available for all categories
  phone     String?
  email     String?
  address   String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  expenses Expense[]

  @@index([category])
  @@index([name])
}

model Expense {
  id                 String          @id @default(cuid())
  category           ExpenseCategory
  description        String
  amount             Int
  method             PaymentMethod
  date               DateTime
  vendorName         String?         // DEPRECATED: Use supplier relation instead
  receiptUrl         String?         // DEPRECATED: Use receiptFile instead
  status             ExpenseStatus   @default(pending)
  requestedBy        String
  approvedBy         String?
  approvedAt         DateTime?
  rejectionReason    String?
  paidAt             DateTime?

  // NEW FIELDS
  supplierId         String?
  billingReferenceId String?         // Invoice/receipt number
  receiptFile        Bytes?          @db.ByteA // Store file content in database
  receiptFileName    String?         // Original filename
  receiptFileType    String?         // MIME type (image/png, application/pdf, etc.)
  initiatedById      String?         // Staff who initiated the expense

  syncVersion        Int             @default(0)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  supplier           Supplier?       @relation(fields: [supplierId], references: [id])
  requester          User            @relation("ExpenseRequester", fields: [requestedBy], references: [id])
  approver           User?           @relation("ExpenseApprover", fields: [approvedBy], references: [id])
  initiatedBy        User?           @relation("ExpenseInitiator", fields: [initiatedById], references: [id])

  @@index([category])
  @@index([date])
  @@index([status])
  @@index([requestedBy])
  @@index([approvedBy])
  @@index([supplierId])
  @@index([initiatedById])
}

model GradeRoom {
  id                 String                  @id @default(cuid())
  gradeId            String
  name               String
  displayName        String
  capacity           Int                     @default(35)
  isActive           Boolean                 @default(true)
  syncVersion        Int                     @default(0)
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  grade              Grade                   @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  studentAssignments StudentRoomAssignment[]
  scheduleSlots      ScheduleSlot[]

  @@unique([gradeId, name])
  @@index([gradeId])
  @@index([isActive])
}

model StudentRoomAssignment {
  id               String         @id @default(cuid())
  studentProfileId String
  gradeRoomId      String
  schoolYearId     String
  assignedAt       DateTime       @default(now())
  assignedBy       String
  isActive         Boolean        @default(true)
  syncVersion      Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  gradeRoom        GradeRoom      @relation(fields: [gradeRoomId], references: [id], onDelete: Cascade)
  schoolYear       SchoolYear     @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  assigner         User           @relation("RoomAssigner", fields: [assignedBy], references: [id])

  @@unique([studentProfileId, schoolYearId])
  @@index([gradeRoomId])
  @@index([schoolYearId])
  @@index([assignedBy])
  @@index([isActive])
}

model UserInvitation {
  id         String    @id @default(cuid())
  email      String
  name       String?
  role       Role
  token      String    @unique
  expiresAt  DateTime
  invitedBy  String
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  inviter    User      @relation("InvitationSender", fields: [invitedBy], references: [id])

  @@index([email])
  @@index([token])
  @@index([invitedBy])
  @@index([expiresAt])
}

// === CLUB MODELS ===

model ClubCategory {
  id          String         @id @default(cuid())
  name        String // English name
  nameFr      String // French name
  description String?
  status      CategoryStatus @default(active)
  order       Int            @default(0)
  syncVersion Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  clubs       Club[]

  @@index([status])
  @@index([order])
}

model Club {
  id              String               @id @default(cuid())
  name            String
  nameFr          String?
  description     String?
  schoolYearId    String
  startDate       DateTime
  endDate         DateTime
  fee             Int // One-time fee (for backwards compat)
  monthlyFee      Int? // Monthly fee for recurring charges
  capacity        Int                  @default(30)
  status          ClubStatus           @default(draft)
  isEnabled       Boolean              @default(true)
  createdBy       String
  categoryId      String? // Link to ClubCategory
  leaderId        String? // Polymorphic leader ID (teacher/staff/student)
  leaderType      ClubLeaderType? // Discriminator for leader type
  syncVersion     Int                  @default(0)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  schoolYear      SchoolYear           @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  creator         User                 @relation("ClubCreator", fields: [createdBy], references: [id])
  category        ClubCategory?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  enrollments     ClubEnrollment[]
  payments        ClubPayment[]
  eligibilityRule ClubEligibilityRule?

  @@index([schoolYearId])
  @@index([categoryId])
  @@index([status])
  @@index([createdBy])
  @@index([leaderId, leaderType])
  @@index([isEnabled])
  @@index([schoolYearId, status, isEnabled]) // Performance: for filtering active clubs
}

model ClubEligibilityRule {
  id          String              @id @default(cuid())
  clubId      String              @unique
  ruleType    EligibilityRuleType
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  club        Club                @relation(fields: [clubId], references: [id], onDelete: Cascade)
  gradeRules  ClubGradeRule[]
  seriesRules ClubSeriesRule[]

  @@index([clubId])
}

model ClubGradeRule {
  id                String              @id @default(cuid())
  eligibilityRuleId String
  gradeId           String
  createdAt         DateTime            @default(now())
  eligibilityRule   ClubEligibilityRule @relation(fields: [eligibilityRuleId], references: [id], onDelete: Cascade)
  grade             Grade               @relation(fields: [gradeId], references: [id], onDelete: Cascade)

  @@unique([eligibilityRuleId, gradeId])
  @@index([eligibilityRuleId])
  @@index([gradeId])
}

model ClubSeriesRule {
  id                String              @id @default(cuid())
  eligibilityRuleId String
  series            String // "Sciences", "Lettres", etc.
  createdAt         DateTime            @default(now())
  eligibilityRule   ClubEligibilityRule @relation(fields: [eligibilityRuleId], references: [id], onDelete: Cascade)

  @@unique([eligibilityRuleId, series])
  @@index([eligibilityRuleId])
}

model ClubEnrollment {
  id               String               @id @default(cuid())
  enrollmentNumber String?              @unique // Human-readable enrollment number (e.g., CE-2026-0001)
  clubId           String
  studentProfileId String
  status           String               @default("active")
  enrolledBy       String
  enrolledAt       DateTime             @default(now())
  // Monthly enrollment tracking
  startMonth       Int? // 1-12 (October=10)
  startYear        Int? // 2024
  totalMonths      Int? // Number of months enrolled
  totalFee         Int? // Pre-calculated total fee
  syncVersion      Int                  @default(0)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  club             Club                 @relation(fields: [clubId], references: [id], onDelete: Cascade)
  studentProfile   StudentProfile       @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  enroller         User                 @relation("ClubEnroller", fields: [enrolledBy], references: [id])
  clubPayments     ClubPayment[]
  monthlyPayments  ClubMonthlyPayment[]
  payments         Payment[]

  @@unique([clubId, studentProfileId])
  @@index([clubId])
  @@index([studentProfileId])
  @@index([enrolledBy])
  @@index([status, clubId]) // Performance: for counting active enrollments
}

model ClubMonthlyPayment {
  id               String         @id @default(cuid())
  clubEnrollmentId String
  month            Int // 1-12
  year             Int // 2024
  amount           Int // Amount for this month
  isPaid           Boolean        @default(false)
  paidAt           DateTime?
  clubPaymentId    String? // Links to actual payment record
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  clubEnrollment   ClubEnrollment @relation(fields: [clubEnrollmentId], references: [id], onDelete: Cascade)
  clubPayment      ClubPayment?   @relation(fields: [clubPaymentId], references: [id], onDelete: SetNull)

  @@unique([clubEnrollmentId, month, year])
  @@index([clubEnrollmentId])
  @@index([isPaid])
  @@index([clubPaymentId])
}

model ClubPayment {
  id               String               @id @default(cuid())
  clubId           String
  clubEnrollmentId String?
  amount           Int
  method           PaymentMethod
  status           PaymentStatus        @default(confirmed)
  receiptNumber    String               @unique
  transactionRef   String?
  receiptImageUrl  String?
  recordedBy       String
  recordedAt       DateTime             @default(now())
  confirmedBy      String?
  confirmedAt      DateTime?
  notes            String?
  syncVersion      Int                  @default(0)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  club             Club                 @relation(fields: [clubId], references: [id], onDelete: Cascade)
  clubEnrollment   ClubEnrollment?      @relation(fields: [clubEnrollmentId], references: [id], onDelete: SetNull)
  recorder         User                 @relation("ClubPaymentRecorder", fields: [recordedBy], references: [id])
  confirmer        User?                @relation("ClubPaymentConfirmer", fields: [confirmedBy], references: [id])
  monthlyPayments  ClubMonthlyPayment[]

  @@index([clubId])
  @@index([clubEnrollmentId])
  @@index([status])
  @@index([recordedBy])
  @@index([confirmedBy])
}

model Trimester {
  id                String                    @id @default(cuid())
  schoolYearId      String
  number            Int
  name              String
  nameFr            String
  nameEn            String
  startDate         DateTime
  endDate           DateTime
  isActive          Boolean                   @default(false)
  syncVersion       Int                       @default(0)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  schoolYear        SchoolYear                @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  evaluations       Evaluation[]
  subjectAverages   SubjectTrimesterAverage[]
  studentTrimesters StudentTrimester[]
  classStats        ClassTrimesterStats[]

  @@unique([schoolYearId, number])
  @@index([schoolYearId])
  @@index([isActive])
}

model Evaluation {
  id               String         @id @default(cuid())
  studentProfileId String
  gradeSubjectId   String
  trimesterId      String
  type             EvaluationType
  score            Float
  maxScore         Float          @default(20)
  date             DateTime
  notes            String?
  recordedBy       String
  syncVersion      Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  gradeSubject     GradeSubject   @relation(fields: [gradeSubjectId], references: [id], onDelete: Cascade)
  trimester        Trimester      @relation(fields: [trimesterId], references: [id], onDelete: Cascade)
  recorder         User           @relation("EvaluationRecorder", fields: [recordedBy], references: [id])

  @@index([studentProfileId])
  @@index([gradeSubjectId])
  @@index([trimesterId])
  @@index([type])
  @@index([recordedBy])
  @@index([studentProfileId, gradeSubjectId, trimesterId])
}

model SubjectTrimesterAverage {
  id               String         @id @default(cuid())
  studentProfileId String
  gradeSubjectId   String
  trimesterId      String
  average          Float?
  teacherRemark    String?
  calculatedAt     DateTime?
  syncVersion      Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  gradeSubject     GradeSubject   @relation(fields: [gradeSubjectId], references: [id], onDelete: Cascade)
  trimester        Trimester      @relation(fields: [trimesterId], references: [id], onDelete: Cascade)

  @@unique([studentProfileId, gradeSubjectId, trimesterId])
  @@index([studentProfileId])
  @@index([gradeSubjectId])
  @@index([trimesterId])
}

model StudentTrimester {
  id                 String            @id @default(cuid())
  studentProfileId   String
  trimesterId        String
  generalAverage     Float?
  rank               Int?
  totalStudents      Int?
  conduct            Float?
  decision           TrimesterDecision @default(pending)
  decisionOverride   Boolean           @default(false)
  decisionOverrideBy String?
  decisionOverrideAt DateTime?
  overrideReason     String?
  generalRemark      String?
  absences           Int               @default(0)
  lates              Int               @default(0)
  calculatedAt       DateTime?
  syncVersion        Int               @default(0)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  studentProfile     StudentProfile    @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  trimester          Trimester         @relation(fields: [trimesterId], references: [id], onDelete: Cascade)
  overrider          User?             @relation("TrimesterDecisionOverrider", fields: [decisionOverrideBy], references: [id])

  @@unique([studentProfileId, trimesterId])
  @@index([studentProfileId])
  @@index([trimesterId])
  @@index([decision])
  @@index([decisionOverrideBy])
}

model ClassTrimesterStats {
  id             String    @id @default(cuid())
  gradeId        String
  trimesterId    String
  totalStudents  Int
  classAverage   Float?
  highestAverage Float?
  lowestAverage  Float?
  passCount      Int       @default(0)
  passRate       Float?
  calculatedAt   DateTime?
  syncVersion    Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  grade          Grade     @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  trimester      Trimester @relation(fields: [trimesterId], references: [id], onDelete: Cascade)

  @@unique([gradeId, trimesterId])
  @@index([gradeId])
  @@index([trimesterId])
}

// === TREASURY MODELS ===

model TreasuryBalance {
  id                  String    @id @default(cuid())
  registryBalance     Int       @default(0)
  registryFloatAmount Int       @default(2000000)
  safeBalance         Int       @default(0)
  bankBalance         Int       @default(0)
  mobileMoneyBalance  Int       @default(0)
  safeThresholdMin    Int       @default(5000000)
  safeThresholdMax    Int       @default(20000000)
  lastVerifiedAt      DateTime?
  lastVerifiedBy      String?
  syncVersion         Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  verifier            User?     @relation("SafeVerifier", fields: [lastVerifiedBy], references: [id])

  @@index([lastVerifiedBy])
}

model SafeTransaction {
  id                      String              @id @default(cuid())
  type                    SafeTransactionType
  direction               CashDirection
  amount                  Int
  registryBalanceAfter    Int?
  safeBalanceAfter        Int
  bankBalanceAfter        Int?
  mobileMoneyBalanceAfter Int?
  description             String?
  referenceType           String?
  referenceId             String?
  studentId               String?
  payerName               String?
  beneficiaryName         String?
  category                String?
  receiptNumber           String?             @unique
  recordedBy              String
  recordedAt              DateTime            @default(now())
  notes                   String?
  isReversal              Boolean             @default(false)
  reversalReason          String?
  reversedBy              String?
  reversedAt              DateTime?
  originalTransactionId   String?
  syncVersion             Int                 @default(0)
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  recorder                User                @relation("SafeTransactionRecorder", fields: [recordedBy], references: [id])
  student                 Student?            @relation(fields: [studentId], references: [id])
  originalTransaction     SafeTransaction?    @relation("ReversalOriginal", fields: [originalTransactionId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  reversals               SafeTransaction[]   @relation("ReversalOriginal")

  @@index([recordedAt])
  @@index([type])
  @@index([direction])
  @@index([referenceType, referenceId])
  @@index([recordedBy])
  @@index([studentId])
  @@index([isReversal])
  @@index([originalTransactionId])
}

model BankTransfer {
  id                String           @id @default(cuid())
  type              BankTransferType
  amount            Int
  bankName          String?
  bankReference     String?
  transferDate      DateTime         @default(now())
  safeBalanceBefore Int
  safeBalanceAfter  Int
  bankBalanceBefore Int
  bankBalanceAfter  Int
  carriedBy         String?
  recordedBy        String
  recordedAt        DateTime         @default(now())
  notes             String?
  syncVersion       Int              @default(0)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  recorder          User             @relation("BankTransferRecorder", fields: [recordedBy], references: [id])

  @@index([type])
  @@index([transferDate])
  @@index([recordedBy])
}

model DailyVerification {
  id               String             @id @default(cuid())
  verificationDate DateTime           @db.Date
  expectedBalance  Int
  countedBalance   Int
  discrepancy      Int
  status           VerificationStatus @default(matched)
  explanation      String?
  verifiedBy       String
  verifiedAt       DateTime           @default(now())
  reviewedBy       String?
  reviewedAt       DateTime?
  reviewNotes      String?
  syncVersion      Int                @default(0)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  verifier         User               @relation("DailyVerifier", fields: [verifiedBy], references: [id])
  reviewer         User?              @relation("DiscrepancyReviewer", fields: [reviewedBy], references: [id])

  @@unique([verificationDate])
  @@index([verifiedBy])
  @@index([reviewedBy])
  @@index([status])
}

model ReconciliationEvent {
  id              String               @id @default(cuid())
  type            ReconciliationType
  periodStart     DateTime
  periodEnd       DateTime
  expectedTotal   Int
  actualTotal     Int
  discrepancy     Int
  status          ReconciliationStatus @default(pending)
  resolutionNotes String?
  performedBy     String
  performedAt     DateTime             @default(now())
  reviewedBy      String?
  reviewedAt      DateTime?
  syncVersion     Int                  @default(0)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  performer       User                 @relation("ReconciliationPerformer", fields: [performedBy], references: [id])
  reviewer        User?                @relation("ReconciliationReviewer", fields: [reviewedBy], references: [id])

  @@index([type])
  @@index([periodStart])
  @@index([status])
  @@index([performedBy])
  @@index([reviewedBy])
}

enum Role {
  user
  director
  academic_director
  secretary
  accountant
  teacher
  parent
  student
}

enum UserStatus {
  invited
  active
  inactive
}

enum SchoolLevel {
  elementary
  college
  high_school
  kindergarten
}

enum EnrollmentStatus {
  draft
  submitted
  needs_review
  completed
  rejected
  cancelled
}

enum PaymentMethod {
  cash
  orange_money
}

enum PaymentType {
  tuition
  club
}

enum PaymentStatus {
  confirmed
  reversed
  failed
}

enum ExpenseStatus {
  pending
  approved
  rejected
  paid
}

enum ExpenseCategory {
  supplies
  maintenance
  utilities
  salary
  transport
  communication
  other
}

enum SchoolYearStatus {
  new
  active
  passed
}

enum ClubStatus {
  draft
  active
  closed
  completed
  cancelled
}

enum CategoryStatus {
  active
  inactive
}

enum EligibilityRuleType {
  all_grades
  include_only
  exclude_only
}

enum ClubLeaderType {
  teacher
  staff
  student
}

enum DayOfWeek {
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
}

enum EvaluationType {
  interrogation
  devoir_surveille
  composition
}

enum TrimesterDecision {
  pending
  admis
  rattrapage
  redouble
}

enum StudentStatus {
  active
  inactive
  graduated
  transferred
  suspended
}

enum AttendanceStatus {
  present
  absent
  late
  excused
}

enum Gender {
  male
  female
}

enum PersonStatus {
  active
  inactive
  archived
}

enum AttendanceEntryMode {
  checklist
  absences_only
}

// === TREASURY ENUMS ===

enum SafeTransactionType {
  student_payment
  club_payment
  other_income
  expense_payment
  bank_deposit
  bank_withdrawal
  adjustment
  mobile_money_income
  mobile_money_payment
  mobile_money_fee
  reversal_student_payment
  reversal_expense_payment
  reversal_bank_deposit
  reversal_mobile_money
  safe_to_registry
  registry_to_safe
  registry_adjustment
}

enum CashDirection {
  in
  out
}

enum BankTransferType {
  deposit
  withdrawal
}

enum VerificationStatus {
  matched
  discrepancy
  reviewed
}

enum ReconciliationType {
  monthly_payments
  monthly_expenses
  bank_statement
  safe_to_bank
  full_audit
}

enum ReconciliationStatus {
  pending
  matched
  discrepancies_found
  resolved
}

// === STAFF ROLES & PERMISSIONS SYSTEM ===

// Staff role enum - 13 distinct roles for RBAC
enum StaffRole {
  // Secondary School (Secondaire)
  proviseur // Principal - Full oversight of secondary education
  censeur // Vice Principal - Academic programs and teacher management
  surveillant_general // Dean of Students - Discipline and daily supervision

  // Primary School (Primaire & Maternelle)
  directeur // Director - Full oversight of primary education
  secretariat // Secretary - Administrative support, enrollment processing

  // Finance Team
  comptable // Accountant - Financial management, safe/bank oversight
  agent_recouvrement // Collections Agent - Fee collection, payment intents
  coordinateur // Operations Coordinator - Cross-level operations

  // Teaching Staff
  enseignant // Teacher - Teaching, grading own classes
  professeur_principal // Homeroom Teacher - Teacher + class oversight

  // Security (minimal system access)
  gardien // Day/Night Guard - Campus security

  // Leadership
  proprietaire // Owner - Strategic oversight, financial visibility
  admin_systeme // System Admin - Technical management, full access
}

// Permission resources - what can be accessed
enum PermissionResource {
  // Student Management
  students
  student_enrollment
  student_transfer
  student_documents

  // Academic Management
  classes
  subjects
  academic_year
  teachers_assignment
  schedule
  club_enrollment

  // Grades & Report Cards
  grades
  report_cards
  grade_approval

  // Attendance
  attendance
  attendance_justification

  // Fee Management
  fee_structure
  fee_assignment
  student_balance
  payment_recording
  receipts

  // Cash & Treasury
  safe_balance
  safe_income
  safe_expense
  bank_transfers
  daily_verification
  financial_reports

  // Staff Management
  staff
  staff_assignment

  // User & Access Management
  user_accounts
  role_assignment
  permission_overrides

  // Discipline
  discipline_records
  sanctions

  // Communication
  sms
  announcements

  // Reports & Analytics
  academic_reports
  attendance_reports
  financial_analytics
  data_export

  // System Settings
  school_settings
  system_settings
  audit_logs
}

// Permission actions - what can be done
enum PermissionAction {
  view
  create
  update
  delete
  approve
  export
}

// Permission scope - which records can be accessed
enum PermissionScope {
  all // All records in system
  own_level // Only records from user's school level
  own_classes // Only records from user's assigned classes
  own_children // Only user's own children (for parents)
  none // No access
}

// === STAFF ROLES & PERMISSIONS MODELS ===

// Default permissions for each role (seeded data)
model RolePermission {
  id       String             @id @default(cuid())
  role     StaffRole
  resource PermissionResource
  action   PermissionAction
  scope    PermissionScope    @default(all)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([role, resource, action])
  @@index([role])
  @@index([resource])
}

// Permission overrides for specific users (exceptions to role defaults)
model PermissionOverride {
  id       String             @id @default(cuid())
  userId   String
  resource PermissionResource
  action   PermissionAction
  scope    PermissionScope

  granted Boolean @default(true) // true=GRANT, false=DENY
  reason  String? // Why this override exists

  grantedBy String // Admin who created override
  grantedAt DateTime  @default(now())
  expiresAt DateTime? // Optional expiration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User @relation("UserPermissionOverrides", fields: [userId], references: [id], onDelete: Cascade)
  grantor User @relation("GrantedPermissionOverrides", fields: [grantedBy], references: [id])

  @@unique([userId, resource, action])
  @@index([userId])
  @@index([grantedBy])
  @@index([resource, action])
}

// Audit log for tracking all permission-checked actions
model AuditLog {
  id         String  @id @default(cuid())
  userId     String
  action     String // "view_student", "edit_grade", etc.
  resource   String // "student", "grade", "payment", etc.
  resourceId String? // ID of specific record

  granted Boolean // Was access granted or denied?
  reason  String? // Reason for denial (if applicable)

  // Request context
  ipAddress     String?
  userAgent     String?
  requestPath   String?
  requestMethod String?

  // Additional context (JSON for flexibility)
  metadata Json?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([resource, resourceId])
  @@index([granted, createdAt])
  @@index([createdAt])
}
