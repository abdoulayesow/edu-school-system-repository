// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider     = "postgresql"
  relationMode = "prisma"
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  user
  director
  academic_director
  secretary
  accountant
  teacher
  parent
  student
}

enum UserStatus {
  invited
  active
  inactive
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  dateOfBirth   DateTime?
  phone         String?
  role          Role       @default(user)
  status        UserStatus @default(active)
  accounts      Account[]
  sessions      Session[]
  address       Address?
  passwordResetTokens  PasswordResetToken[]
  recordedAttendance   Attendance[]
  teachingClasses      Class[]

  // Enrollment relations
  createdEnrollments   Enrollment[]     @relation("EnrollmentCreator")
  approvedEnrollments  Enrollment[]     @relation("EnrollmentApprover")
  statusChangedEnrollments Enrollment[] @relation("EnrollmentStatusChanger")
  recordedPayments     Payment[]        @relation("PaymentRecorder")
  confirmedPayments    Payment[]        @relation("PaymentConfirmer")
  reviewedPayments     Payment[]        @relation("PaymentReviewer")
  enrollmentNotes      EnrollmentNote[]

  // Attendance relations
  attendanceSessions   AttendanceSession[] @relation("AttendanceSessionRecorder")
  attendanceRecords    AttendanceRecord[]  @relation("AttendanceRecordRecorder")

  // Cash deposit relations
  depositedCash        CashDeposit[]    @relation("CashDepositor")
  verifiedDeposits     CashDeposit[]    @relation("DepositVerifier")

  // Bank deposit relations
  recordedBankDeposits BankDeposit[]    @relation("BankDepositRecorder")
  reconciledBankDeposits BankDeposit[]  @relation("BankDepositReconciler")

  // Expense relations
  requestedExpenses    Expense[]        @relation("ExpenseRequester")
  approvedExpenses     Expense[]        @relation("ExpenseApprover")
}

model Address {
  id      String  @id @default(cuid())
  street  String?
  city    String?
  state   String?
  zip     String?
  country String?
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId  String  @unique
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ============================================================================
// School Year & Enrollment System
// ============================================================================

enum SchoolLevel {
  elementary    // Primaire (Grades 1-6)
  college       // College (Grades 7-10)
  high_school   // Lycee (Grades 11-12 + Terminal)
}

enum EnrollmentStatus {
  draft              // In-progress enrollment
  submitted          // Submitted, awaiting auto-approval (3 days)
  needs_review       // Needs director review (payment amount changed)
  completed          // Approved and finalized
  rejected           // Rejected by director (returned for changes)
  cancelled          // Cancelled by user
}

enum PaymentMethod {
  cash
  orange_money
}

enum PaymentStatus {
  pending_deposit   // Cash payment awaiting bank deposit
  deposited         // Cash deposited at bank, awaiting review
  pending_review    // Orange Money or deposited cash awaiting final review
  confirmed         // Payment fully confirmed
  rejected          // Payment rejected during review
  failed            // Payment failed
}

enum ExpenseStatus {
  pending           // Awaiting approval
  approved          // Approved by director
  rejected          // Rejected by director
  paid              // Expense has been paid
}

enum ExpenseCategory {
  supplies          // School supplies
  maintenance       // Building/equipment maintenance
  utilities         // Electricity, water, etc.
  salary            // Staff salaries
  transport         // Transportation costs
  communication     // Phone, internet
  other             // Miscellaneous
}

model SchoolYear {
  id              String       @id @default(cuid())
  name            String       // "2025 - 2026"
  startDate       DateTime     // September 1, 2025
  endDate         DateTime     // June 30, 2026
  enrollmentStart DateTime     // July 1, 2025
  enrollmentEnd   DateTime     // June 15, 2026
  isActive        Boolean      @default(false)
  syncVersion     Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  grades            Grade[]
  enrollments       Enrollment[]
  classAssignments  ClassAssignment[]
  gradeEnrollments  GradeEnrollment[]

  @@index([isActive])
  @@index([startDate])
}

model Grade {
  id              String      @id @default(cuid())
  name            String      // "7eme Annee"
  code            String?     // "7EME" - Short code for the grade
  level           SchoolLevel
  order           Int         // 1-13 for sorting
  tuitionFee      Int         // Annual fee in GNF
  schoolYearId    String
  gradeLeaderId   String?     // Teacher who leads this grade (responsable de classe)
  syncVersion     Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  schoolYear      SchoolYear  @relation(fields: [schoolYearId], references: [id], onDelete: Cascade)
  gradeLeader     TeacherProfile? @relation("GradeLeader", fields: [gradeLeaderId], references: [id])
  enrollments     Enrollment[]
  subjects        GradeSubject[]
  currentStudents StudentProfile[] @relation("CurrentGradeStudents")
  gradeEnrollments GradeEnrollment[]
  attendanceSessions AttendanceSession[]

  @@unique([schoolYearId, order])
  @@index([schoolYearId])
  @@index([level])
  @@index([order])
  @@index([gradeLeaderId])
}

model Enrollment {
  id                  String           @id @default(cuid())
  enrollmentNumber    String?          @unique // ENR-2025-00001
  studentId           String?          // For returning students
  schoolYearId        String
  gradeId             String

  // Student info (denormalized for new students)
  firstName           String
  lastName            String
  dateOfBirth         DateTime?
  gender              String?          // "male" | "female"
  phone               String?
  email               String?
  photoUrl            String?
  birthCertificateUrl String?

  // Parent info
  fatherName          String?
  fatherPhone         String?
  fatherEmail         String?
  motherName          String?
  motherPhone         String?
  motherEmail         String?
  address             String?

  // Financial
  originalTuitionFee  Int              // Original fee from Grade
  adjustedTuitionFee  Int?             // If different from original (requires approval)
  adjustmentReason    String?          // Why fee was adjusted

  // Status tracking
  status              EnrollmentStatus @default(draft)
  currentStep         Int              @default(1) // 1-6 wizard step
  isReturningStudent  Boolean          @default(false)
  draftExpiresAt      DateTime?        // 10 days from last update
  submittedAt         DateTime?
  approvedAt          DateTime?
  approvedBy          String?          // User ID who approved
  autoApproveAt       DateTime?        // 3 days after submission

  // Status change tracking (for completed/rejected/cancelled)
  statusComment       String?          // Required comment when completing/rejecting/cancelling
  statusChangedAt     DateTime?        // When status was last changed
  statusChangedBy     String?          // User ID who changed status

  // Sync & audit
  createdBy           String           // User ID who created
  syncVersion         Int              @default(0)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  // Relations
  schoolYear          SchoolYear       @relation(fields: [schoolYearId], references: [id])
  grade               Grade            @relation(fields: [gradeId], references: [id])
  student             Student?         @relation(fields: [studentId], references: [id])
  creator             User             @relation("EnrollmentCreator", fields: [createdBy], references: [id])
  approver            User?            @relation("EnrollmentApprover", fields: [approvedBy], references: [id])
  statusChanger       User?            @relation("EnrollmentStatusChanger", fields: [statusChangedBy], references: [id])
  paymentSchedules    PaymentSchedule[]
  payments            Payment[]
  notes               EnrollmentNote[]

  @@index([status, schoolYearId])
  @@index([schoolYearId])
  @@index([gradeId])
  @@index([studentId])
  @@index([createdBy])
  @@index([draftExpiresAt])
  @@index([updatedAt])
  @@index([statusChangedBy])
}

model PaymentSchedule {
  id              String     @id @default(cuid())
  enrollmentId    String
  scheduleNumber  Int        // 1, 2, or 3
  amount          Int        // Amount in GNF
  months          String[]   // ["September", "October", "May"]
  dueDate         DateTime
  isPaid          Boolean    @default(false)
  paidAt          DateTime?
  syncVersion     Int        @default(0)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  enrollment      Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  payments        Payment[]

  @@unique([enrollmentId, scheduleNumber])
  @@index([enrollmentId])
  @@index([dueDate])
}

model Payment {
  id                  String          @id @default(cuid())
  enrollmentId        String
  paymentScheduleId   String?
  amount              Int             // Amount in GNF
  method              PaymentMethod
  status              PaymentStatus   @default(pending_deposit)

  // Transaction details
  receiptNumber       String          // Required: CASH-2025-XXXXX or OM-2025-XXXXX
  transactionRef      String?         // Orange Money transaction ID
  receiptImageUrl     String?         // Uploaded receipt image

  // Recording info
  recordedBy          String          // User ID
  recordedAt          DateTime        @default(now())
  confirmedBy         String?         // User ID
  confirmedAt         DateTime?
  notes               String?

  // Review tracking
  reviewedBy          String?         // User ID who reviewed
  reviewedAt          DateTime?
  reviewNotes         String?         // Notes from reviewer (especially for rejection)
  autoConfirmAt       DateTime?       // 24h after Orange Money payment for auto-confirmation

  syncVersion         Int             @default(0)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  enrollment          Enrollment      @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  paymentSchedule     PaymentSchedule? @relation(fields: [paymentScheduleId], references: [id])
  recorder            User            @relation("PaymentRecorder", fields: [recordedBy], references: [id])
  confirmer           User?           @relation("PaymentConfirmer", fields: [confirmedBy], references: [id])
  reviewer            User?           @relation("PaymentReviewer", fields: [reviewedBy], references: [id])
  cashDeposit         CashDeposit?    // For cash payments - deposit info

  @@index([enrollmentId])
  @@index([paymentScheduleId])
  @@index([status])
  @@index([recordedBy])
  @@index([recordedAt])
  @@index([reviewedBy])
  @@index([method])
}

model EnrollmentNote {
  id            String     @id @default(cuid())
  enrollmentId  String
  title         String
  content       String
  createdBy     String     // User ID
  syncVersion   Int        @default(0)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  enrollment    Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  author        User       @relation(fields: [createdBy], references: [id])

  @@index([enrollmentId])
  @@index([createdBy])
}

// ============================================================================
// Student Management (Offline-First Priority)
// ============================================================================

enum StudentStatus {
  active
  inactive
  graduated
  transferred
  suspended
}

enum AttendanceStatus {
  present
  absent
  late
  excused
}

model Student {
  id             String        @id @default(cuid())
  studentNumber  String?       @unique // STU-00001
  firstName      String
  lastName       String
  email          String?
  dateOfBirth    DateTime?
  guardianName   String?
  guardianPhone  String?
  guardianEmail  String?
  grade          String?
  classId        String?
  status         StudentStatus @default(active)
  enrollmentDate DateTime      @default(now())
  syncVersion    Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  attendance     Attendance[]
  class          Class?        @relation(fields: [classId], references: [id])
  enrollments    Enrollment[]
  studentProfile StudentProfile?

  @@index([status])
  @@index([classId])
  @@index([grade])
  @@index([updatedAt])
  @@index([studentNumber])
  @@index([firstName, lastName])
}

model Attendance {
  id          String           @id @default(cuid())
  studentId   String
  date        DateTime         @db.Date
  status      AttendanceStatus
  notes       String?
  recordedBy  String
  syncVersion Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  recorder    User             @relation(fields: [recordedBy], references: [id])

  @@unique([studentId, date])
  @@index([studentId])
  @@index([date])
  @@index([recordedBy])
  @@index([updatedAt])
}

model Class {
  id        String    @id @default(cuid())
  name      String
  grade     String?
  teacherId String?
  year      Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  students  Student[]
  teacher   User?     @relation(fields: [teacherId], references: [id])

  @@index([teacherId])
  @@index([year])
}

// ============================================================================
// Person System - Unified Identity Management
// ============================================================================

enum Gender {
  male
  female
}

enum PersonStatus {
  active
  inactive
  archived
}

model Person {
  id             String        @id @default(cuid())
  firstName      String
  lastName       String
  email          String?       @unique
  phone          String?
  dateOfBirth    DateTime?
  gender         Gender?
  photoUrl       String?
  address        String?
  status         PersonStatus  @default(active)
  syncVersion    Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Role-specific profiles (one person can have multiple roles)
  userProfile      UserProfile?
  studentProfile   StudentProfile?
  teacherProfile   TeacherProfile?
  parentProfile    ParentProfile?

  @@index([email])
  @@index([firstName, lastName])
  @@index([status])
}

model UserProfile {
  id            String      @id @default(cuid())
  personId      String      @unique
  userId        String?     @unique  // Links to legacy User table during migration
  role          Role        @default(user)
  userStatus    UserStatus  @default(active)
  syncVersion   Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  person        Person      @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@index([role])
}

model StudentProfile {
  id              String        @id @default(cuid())
  personId        String        @unique
  studentId       String?       @unique  // Links to legacy Student table during migration
  studentNumber   String?       @unique  // STU-00001
  studentStatus   StudentStatus @default(active)
  enrollmentDate  DateTime      @default(now())
  currentGradeId  String?
  syncVersion     Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  person          Person        @relation(fields: [personId], references: [id], onDelete: Cascade)
  student         Student?      @relation(fields: [studentId], references: [id])
  currentGrade    Grade?        @relation("CurrentGradeStudents", fields: [currentGradeId], references: [id])
  gradeEnrollments GradeEnrollment[]
  attendanceRecords AttendanceRecord[]
  parentLinks     StudentParent[]

  @@index([personId])
  @@index([studentNumber])
  @@index([currentGradeId])
  @@index([studentStatus])
}

model TeacherProfile {
  id              String    @id @default(cuid())
  personId        String    @unique
  userId          String?   @unique  // Links to legacy User with role=teacher during migration
  employeeNumber  String?   @unique
  hireDate        DateTime?
  specialization  String?
  syncVersion     Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  person          Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  classAssignments ClassAssignment[]
  gradeLederships Grade[]   @relation("GradeLeader")

  @@index([personId])
  @@index([employeeNumber])
}

model ParentProfile {
  id            String    @id @default(cuid())
  personId      String    @unique
  relationship  String?   // "father", "mother", "guardian"
  syncVersion   Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  person        Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  studentLinks  StudentParent[]

  @@index([personId])
}

model StudentParent {
  id              String    @id @default(cuid())
  studentProfileId String
  parentProfileId  String
  isPrimary       Boolean   @default(false)
  createdAt       DateTime  @default(now())

  studentProfile  StudentProfile  @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  parentProfile   ParentProfile   @relation(fields: [parentProfileId], references: [id], onDelete: Cascade)

  @@unique([studentProfileId, parentProfileId])
  @@index([studentProfileId])
  @@index([parentProfileId])
}

// ============================================================================
// Subject & Curriculum Management
// ============================================================================

model Subject {
  id          String    @id @default(cuid())
  code        String    @unique  // "MATH", "FRANCAIS", "ANGLAIS"
  nameFr      String    // "Mathematiques"
  nameEn      String    // "Mathematics"
  isOptional  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  gradeSubjects GradeSubject[]

  @@index([code])
}

model GradeSubject {
  id            String    @id @default(cuid())
  gradeId       String
  subjectId     String
  coefficient   Int       @default(1)
  hoursPerWeek  Int?
  series        String?   // NULL for grades 1-11, "A"/"B"/"C" for Terminal (grade 13)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  grade         Grade     @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  subject       Subject   @relation(fields: [subjectId], references: [id])
  classAssignments ClassAssignment[]

  @@unique([gradeId, subjectId, series])
  @@index([gradeId])
  @@index([subjectId])
}

model ClassAssignment {
  id              String    @id @default(cuid())
  gradeSubjectId  String
  teacherProfileId String
  schoolYearId    String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  gradeSubject    GradeSubject    @relation(fields: [gradeSubjectId], references: [id], onDelete: Cascade)
  teacherProfile  TeacherProfile  @relation(fields: [teacherProfileId], references: [id])
  schoolYear      SchoolYear      @relation(fields: [schoolYearId], references: [id])

  @@unique([gradeSubjectId, schoolYearId])
  @@index([teacherProfileId])
  @@index([schoolYearId])
}

model GradeEnrollment {
  id              String    @id @default(cuid())
  studentProfileId String
  gradeId         String
  schoolYearId    String
  enrolledAt      DateTime  @default(now())
  status          String    @default("active")  // active, transferred, withdrawn
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  studentProfile  StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  grade           Grade          @relation(fields: [gradeId], references: [id])
  schoolYear      SchoolYear     @relation(fields: [schoolYearId], references: [id])

  @@unique([studentProfileId, gradeId, schoolYearId])
  @@index([studentProfileId])
  @@index([gradeId])
  @@index([schoolYearId])
}

// ============================================================================
// Enhanced Attendance System
// ============================================================================

enum AttendanceEntryMode {
  checklist       // Full checklist - mark each student
  absences_only   // Only mark absences/late
}

model AttendanceSession {
  id              String              @id @default(cuid())
  gradeId         String
  date            DateTime            @db.Date
  entryMode       AttendanceEntryMode
  isComplete      Boolean             @default(false)
  completedAt     DateTime?
  recordedBy      String
  syncVersion     Int                 @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  grade           Grade               @relation(fields: [gradeId], references: [id])
  recorder        User                @relation("AttendanceSessionRecorder", fields: [recordedBy], references: [id])
  records         AttendanceRecord[]

  @@unique([gradeId, date])
  @@index([gradeId])
  @@index([date])
  @@index([recordedBy])
  @@index([isComplete])
}

model AttendanceRecord {
  id              String            @id @default(cuid())
  sessionId       String
  studentProfileId String
  status          AttendanceStatus
  notes           String?
  recordedBy      String
  syncVersion     Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  session         AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentProfile  StudentProfile    @relation(fields: [studentProfileId], references: [id])
  recorder        User              @relation("AttendanceRecordRecorder", fields: [recordedBy], references: [id])

  @@unique([sessionId, studentProfileId])
  @@index([studentProfileId])
  @@index([status])
}

// ============================================================================
// Enhanced Payment & Accounting System
// ============================================================================

model CashDeposit {
  id                String    @id @default(cuid())
  paymentId         String    @unique
  bankReference     String
  depositDate       DateTime
  depositedBy       String
  depositedByName   String?   // "Me" or specific name if different
  bankName          String?
  verifiedBy        String?
  verifiedAt        DateTime?
  syncVersion       Int       @default(0)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  payment           Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  depositor         User      @relation("CashDepositor", fields: [depositedBy], references: [id])
  verifier          User?     @relation("DepositVerifier", fields: [verifiedBy], references: [id])

  @@index([depositDate])
  @@index([bankReference])
  @@index([depositedBy])
}

model BankDeposit {
  id                  String    @id @default(cuid())
  bankReference       String    @unique
  amount              Int
  depositDate         DateTime
  bankName            String
  depositorName       String
  recordedBy          String
  isReconciled        Boolean   @default(false)
  reconciledAt        DateTime?
  reconciledBy        String?
  reconciliationNotes String?
  syncVersion         Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  recorder            User      @relation("BankDepositRecorder", fields: [recordedBy], references: [id])
  reconciler          User?     @relation("BankDepositReconciler", fields: [reconciledBy], references: [id])

  @@index([depositDate])
  @@index([isReconciled])
  @@index([recordedBy])
}

model Expense {
  id              String          @id @default(cuid())
  category        ExpenseCategory
  description     String
  amount          Int
  method          PaymentMethod
  date            DateTime
  vendorName      String?
  receiptUrl      String?
  status          ExpenseStatus   @default(pending)
  requestedBy     String
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  paidAt          DateTime?
  syncVersion     Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  requester       User            @relation("ExpenseRequester", fields: [requestedBy], references: [id])
  approver        User?           @relation("ExpenseApprover", fields: [approvedBy], references: [id])

  @@index([category])
  @@index([date])
  @@index([status])
  @@index([requestedBy])
}