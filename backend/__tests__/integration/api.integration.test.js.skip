const request = require('supertest');
const app = require('../../src/index');
const { v4: uuidv4 } = require('uuid');

describe('API Integration Tests', () => {
  let authToken;
  let schoolId;
  let userId;
  let studentId;
  let classId;

  describe('Health & System Endpoints', () => {
    it('GET /api/health should return 200', async () => {
      const res = await request(app).get('/api/health');
      expect(res.status).toBe(200);
      expect(res.body.status).toBe('OK');
      expect(res.body.message).toContain('Friasoft');
    });

    it('GET /api/version should return version info', async () => {
      const res = await request(app).get('/api/version');
      expect(res.status).toBe(200);
      expect(res.body).toHaveProperty('version');
    });
  });

  describe('Authentication Flow', () => {
    it('POST /api/auth/login should return 400 without required fields', async () => {
      const res = await request(app)
        .post('/api/auth/login')
        .send({});

      expect(res.status).toBe(400);
      expect(res.body.code).toBe('VALIDATION_ERROR');
    });

    it('POST /api/auth/login should return 401 with invalid credentials', async () => {
      const res = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'nonexistent@example.com',
          password: 'wrongpassword',
          schoolId: uuidv4()
        });

      expect(res.status).toBe(401);
      expect(res.body.code).toBe('AUTH_INVALID_CREDENTIALS');
    });

    it('POST /api/auth/refresh should return 400 without token', async () => {
      const res = await request(app)
        .post('/api/auth/refresh')
        .send({});

      expect(res.status).toBe(400);
    });
  });

  describe('Schools Endpoints', () => {
    it('GET /api/schools without auth should return 401', async () => {
      const res = await request(app).get('/api/schools');
      expect(res.status).toBe(401);
    });

    it('GET /api/schools with auth should return schools list', async () => {
      // This assumes test data exists from seeding
      const loginRes = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'admin@friasoft-test.com',
          password: 'password123',
          schoolId: '550e8400-e29b-41d4-a716-446655440000' // This should be obtained from database
        });

      if (loginRes.status === 200) {
        authToken = loginRes.body.data.tokens.accessToken;
        const res = await request(app)
          .get('/api/schools')
          .set('Authorization', `Bearer ${authToken}`);

        expect(res.status).toBe(200);
        expect(res.body.status).toBe('OK');
        expect(Array.isArray(res.body.data)).toBe(true);
      }
    });

    it('POST /api/schools should create new school', async () => {
      if (!authToken) return; // Skip if no auth

      const newSchool = {
        name: 'Test School ' + Date.now(),
        email: `test-${Date.now()}@school.com`,
        country: 'Guinea',
        city: 'Conakry',
        subscriptionPlan: 'Premium'
      };

      const res = await request(app)
        .post('/api/schools')
        .set('Authorization', `Bearer ${authToken}`)
        .send(newSchool);

      if (res.status === 201) {
        expect(res.body.status).toBe('CREATED');
        schoolId = res.body.data.id;
      }
    });
  });

  describe('Users Endpoints', () => {
    it('GET /api/users without auth should return 401', async () => {
      const res = await request(app).get('/api/users');
      expect(res.status).toBe(401);
    });

    it('GET /api/users with missing schoolId should return 400', async () => {
      if (!authToken) return;

      const res = await request(app)
        .get('/api/users')
        .set('Authorization', `Bearer ${authToken}`);

      expect(res.status).toBe(400);
    });
  });

  describe('Students Endpoints', () => {
    it('GET /api/students without auth should return 401', async () => {
      const res = await request(app).get('/api/students');
      expect(res.status).toBe(401);
    });

    it('POST /api/students should create new student', async () => {
      if (!authToken || !schoolId) return;

      const newStudent = {
        schoolId,
        firstName: 'Test',
        lastName: 'Student',
        email: `student-${Date.now()}@school.com`,
        gender: 'M'
      };

      const res = await request(app)
        .post('/api/students')
        .set('Authorization', `Bearer ${authToken}`)
        .send(newStudent);

      if (res.status === 201) {
        expect(res.body.status).toBe('CREATED');
        studentId = res.body.data.id;
      }
    });
  });

  describe('Classes Endpoints', () => {
    it('GET /api/classes without auth should return 401', async () => {
      const res = await request(app).get('/api/classes');
      expect(res.status).toBe(401);
    });

    it('POST /api/classes should create new class', async () => {
      if (!authToken || !schoolId) return;

      const newClass = {
        schoolId,
        name: `Form ${Date.now() % 10}`,
        gradeLevel: 1,
        capacity: 30
      };

      const res = await request(app)
        .post('/api/classes')
        .set('Authorization', `Bearer ${authToken}`)
        .send(newClass);

      if (res.status === 201) {
        expect(res.body.status).toBe('CREATED');
        classId = res.body.data.id;
      }
    });
  });

  describe('Subjects Endpoints', () => {
    it('GET /api/subjects without auth should return 401', async () => {
      const res = await request(app).get('/api/subjects');
      expect(res.status).toBe(401);
    });

    it('POST /api/subjects should create new subject', async () => {
      if (!authToken || !schoolId) return;

      const newSubject = {
        schoolId,
        name: `Subject-${Date.now()}`,
        code: `SUB${Date.now() % 1000}`
      };

      const res = await request(app)
        .post('/api/subjects')
        .set('Authorization', `Bearer ${authToken}`)
        .send(newSubject);

      if (res.status === 201) {
        expect(res.body.status).toBe('CREATED');
      }
    });
  });

  describe('Grades Endpoints', () => {
    it('GET /api/grades/student/{id} without auth should return 401', async () => {
      const res = await request(app).get(`/api/grades/student/${uuidv4()}`);
      expect(res.status).toBe(401);
    });

    it('GET /api/grades/student/{id} with auth should return grades', async () => {
      if (!authToken || !studentId) return;

      const res = await request(app)
        .get(`/api/grades/student/${studentId}`)
        .set('Authorization', `Bearer ${authToken}`);

      expect([200, 404]).toContain(res.status);
      if (res.status === 200) {
        expect(Array.isArray(res.body.data)).toBe(true);
      }
    });
  });

  describe('Timetable Endpoints', () => {
    it('GET /api/timetable without auth should return 401', async () => {
      const res = await request(app).get('/api/timetable');
      expect(res.status).toBe(401);
    });

    it('GET /api/timetable with classId should return timetable', async () => {
      if (!authToken || !classId) return;

      const res = await request(app)
        .get(`/api/timetable?classId=${classId}`)
        .set('Authorization', `Bearer ${authToken}`);

      expect([200, 404]).toContain(res.status);
      if (res.status === 200) {
        expect(Array.isArray(res.body.data)).toBe(true);
      }
    });
  });

  describe('Invoices Endpoints', () => {
    it('GET /api/invoices without auth should return 401', async () => {
      const res = await request(app).get('/api/invoices');
      expect(res.status).toBe(401);
    });

    it('GET /api/invoices without schoolId should return 400', async () => {
      if (!authToken) return;

      const res = await request(app)
        .get('/api/invoices')
        .set('Authorization', `Bearer ${authToken}`);

      expect(res.status).toBe(400);
    });

    it('GET /api/invoices with schoolId should return invoices', async () => {
      if (!authToken || !schoolId) return;

      const res = await request(app)
        .get(`/api/invoices?schoolId=${schoolId}`)
        .set('Authorization', `Bearer ${authToken}`);

      expect([200, 404]).toContain(res.status);
      if (res.status === 200) {
        expect(Array.isArray(res.body.data)).toBe(true);
      }
    });

    it('GET /api/invoices/reports/summary should return financial report', async () => {
      if (!authToken || !schoolId) return;

      const res = await request(app)
        .get(`/api/invoices/reports/summary?schoolId=${schoolId}`)
        .set('Authorization', `Bearer ${authToken}`);

      expect([200, 404]).toContain(res.status);
      if (res.status === 200) {
        expect(res.body.status).toBe('OK');
      }
    });
  });

  describe('Error Handling', () => {
    it('should return 404 for non-existent endpoint', async () => {
      const res = await request(app).get('/api/nonexistent');
      expect(res.status).toBe(404);
    });

    it('should return 500-like error for server errors', async () => {
      // This is a placeholder for actual server error testing
      // In a real scenario, you'd mock the database to fail
      const res = await request(app).get('/api/health');
      expect(res.status).toBe(200); // Health check should always work
    });
  });
});
